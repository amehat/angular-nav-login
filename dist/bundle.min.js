!function(e){"use strict";function n(e,n){return n={exports:{}},e(n,n.exports),n.exports}e="default"in e?e.default:e;var t=(function(){function e(e){this.value=e}function n(n){function t(e,n){return new Promise(function(t,i){var u={key:e,arg:n,resolve:t,reject:i,next:null};s?s=s.next=u:(o=s=u,r(e,n))})}function r(t,o){try{var s=n[t](o),u=s.value;u instanceof e?Promise.resolve(u.value).then(function(e){r("next",e)},function(e){r("throw",e)}):i(s.done?"return":"normal",s.value)}catch(e){i("throw",e)}}function i(e,n){switch(e){case"return":o.resolve({value:n,done:!0});break;case"throw":o.reject(n);break;default:o.resolve({value:n,done:!1})}o=o.next,o?r(o.key,o.arg):s=null}var o,s;this._invoke=t,"function"!=typeof n.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype.throw=function(e){return this._invoke("throw",e)},n.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new n(e.apply(this,arguments))}},await:function(n){return new e(n)}}}(),function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}),r=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),i=function(){function e(n){t(this,e),this.loginService=n}return r(e,[{key:"$routerOnActivate",value:function(e){return this.loginService.login(e)}}]),e}();i.$inject=["loginService"];var o={controller:i},s=n(function(e,n){n.decodeBase64Url=function(e){return e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=")},n.omit=function(e,n){return Object.keys(e).reduce(function(t,r){return n.indexOf(r)===-1&&(t[r]=e[r]),t},{})}}),u=s.omit,a=s.decodeBase64Url,c=function(){function e(n,r,i,o,s,u,a,c){t(this,e),this.$http=n,this.$window=r,this.$rootRouter=i,this.config=o,this.sessionService=s,this.toastService=u,this.mainService=a,this.userSessionService=c}return r(e,[{key:"createUser",value:function(e,n){var t={username:e,token:n},r={headers:{"x-api-key":this.config.middleware.key}};return this.$http.post(this.config.middleware.url+"/users",t,r)}},{key:"handleLoginError",value:function(e){var n="Could not log you in";return e&&e.data&&e.data.message&&(n+='. The response was "'+e.data.message+'".'),this.toastService.error("login-failed",n)}},{key:"init",value:function(e){return this.mainService.init(e),this.$rootRouter.navigate(["/Nav"]),e}},{key:"navLogin",value:function(){this.$window.location.href=this.config.nav+"/SignIn.aspx"}},{key:"navLogout",value:function(){this.$window.location.href=this.config.nav+"/SignOut.aspx"}},{key:"loginOrCreateUser",value:function(e,n){var t=this,r=function(){return t.createUser(e,n).then(function(){return t.sessionService.login(e,n)})};return this.sessionService.login(e,n).catch(r)}},{key:"canActivate",value:function(){var e=this,n=function(e,n){return n.ok?n.userCtx&&n.userCtx.name?e.userName?n.userCtx.name.toLowerCase()!==e.userName.toLowerCase()?Promise.reject("session mismatch for user "+e.userName):void 0:Promise.reject("missing user name in local session"):Promise.reject("missing user context in remote session"):Promise.reject("session invalid")},t=function(t){return e.sessionService.getSession().then(function(e){return n(t,e)}).then(function(){return e.init(t)}).catch(function(n){if(!e.$window.navigator.onLine)return e.init(t);throw n})};return this.userSessionService.getSession().then(function(e){return t(e)}).catch(function(n){return e.navLogin(n)})}},{key:"login",value:function(e){var n=this;if(!e.params.username||!e.params.token)return this.canActivate();var t=this.$window.decodeURI(e.params.username).toLowerCase(),r=a(e.params.token),i={lastLogin:(new Date).toISOString()};return this.loginOrCreateUser(t,r).then(function(){return n.sessionService.getUser(t)}).then(function(e){return n.userSessionService.updateRemoteSession(t,e,i)}).then(function(e){return n.userSessionService.setSession(e)}).then(function(e){return n.init(e)}).catch(function(e){return n.handleLoginError(e)})}},{key:"logout",value:function(){var e=this;return this.userSessionService.getSession().then(function(n){return e.sessionService.remove(n)})}}]),e}();c.$inject=["$http","$window","$rootRouter","config","sessionService","toastService","mainService","userSessionService"];var v=["_id","_rev","name","password","roles","type","salt","derived_key","password_scheme","iterations"],f=function(){function e(n){t(this,e),this.sessionService=n}return r(e,[{key:"updateRemoteSession",value:function(e,n,t){var r=u(n,v),i=Object.assign(r,t),o=function(e){return e.ok?Object.assign(i,u(e,["ok"])):n},s={metadata:i};return this.sessionService.putUser(e,s).then(o)}},{key:"getSession",value:function(){return this.sessionService.get("_local/session")}},{key:"setSession",value:function(e){var n=Object.assign({},e,{_id:"_local/session"}),t={forceUpdate:!0};return this.sessionService.save(n,t)}}]),e}();f.$inject=["sessionService"],e.module("angularNavLogin",[]).service("loginService",c).service("userSessionService",f).component("login",o)}(angular);