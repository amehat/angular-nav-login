!function(e){"use strict";function n(e,n){return n={exports:{}},e(n,n.exports),n.exports}e="default"in e?e.default:e;var t=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),r=function(){function e(n){t(this,e),this.loginService=n}return i(e,[{key:"$routerOnActivate",value:function(e){return this.loginService.login(e)}}]),e}();r.$inject=["loginService"];var o={controller:r},s=n(function(e,n){n.decodeBase64Url=function(e){return e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=")}}),a=s.decodeBase64Url,u=function(){function e(n,i,r,o,s,a,u){t(this,e),this.$http=n,this.$window=i,this.$rootRouter=r,this.config=o,this.sessionService=s,this.toastService=a,this.mainService=u}return i(e,[{key:"createUser",value:function(e,n){var t={username:e,token:n},i={headers:{"x-api-key":this.config.middleware.key}};return this.$http.post(this.config.middleware.url+"/users",t,i)}},{key:"handleLoginError",value:function(e){var n="Could not log you in";return e.message&&(n+='. The reply was "'+e.message+'".'),this.toastService.error("login-failed",n)}},{key:"setSession",value:function(e){var n=Object.assign({},e,{_id:"_local/session"}),t={forceUpdate:!0};return this.sessionService.save(n,t)}},{key:"init",value:function(e){return this.mainService.init(e),this.$rootRouter.navigate(["/Nav"]),e}},{key:"navLogin",value:function(){this.$window.location.href=this.config.nav+"/SignIn.aspx"}},{key:"navLogout",value:function(){this.$window.location.href=this.config.nav+"/SignOut.aspx"}},{key:"loginOrCreateUser",value:function(e,n){var t=this,i=function(){return t.createUser(e,n).then(function(){return t.sessionService.login(e,n)})};return this.sessionService.login(e,n).catch(i)}},{key:"getSession",value:function(){return this.sessionService.get("_local/session")}},{key:"canActivate",value:function(){var e=this;return this.getSession().then(function(n){return e.init(n)}).catch(function(n){return e.navLogin(n)})}},{key:"login",value:function(e){var n=this;if(!e.params.username||!e.params.token)return this.canActivate();var t=e.params.username.toLowerCase(),i=a(e.params.token);return this.loginOrCreateUser(t,i).then(function(){return n.sessionService.getUser(t)}).then(function(e){return n.setSession(e)}).then(function(e){return n.init(e)}).catch(function(e){return n.handleLoginError(e)})}},{key:"logout",value:function(){var e=this;return this.getSession().then(function(n){return e.sessionService.remove(n)})}}]),e}();u.$inject=["$http","$window","$rootRouter","config","sessionService","toastService","mainService"],e.module("angularNavLogin",[]).service("loginService",u).component("login",o)}(angular);